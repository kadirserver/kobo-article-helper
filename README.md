> [!IMPORTANT]
> **This project was generated by AI.**

# Kobo Article Helper

This helper listens for new emails arriving at a specified email address, saves their content as HTML, and adds a link to this content to your Instapaper account using the Simple API.

## Features

- **üìß Email Listener:** Automatically checks your inbox for new emails via IMAP at regular intervals (every 60 seconds).
- **üìÑ HTML Conversion:** Saves email content (HTML or text) as UUID-named HTML files, ensuring unique identification.
- **üñºÔ∏è Smart Image Processing:**
    - **Optimization:** Downloads images, converts them to high-quality wrappers (PNG/JPEG), and serves them locally.
    - **Deduplication:** Uses perceptual hashing (`imagehash`) to detect and reuse identical images, saving storage space.
    - **Quality Checks:** Automatically skips low-quality images based on:
        - **Size:** Ignores images smaller than 100px width/height.
        - **Aspect Ratio:** Filters out extremely thin or wide images (e.g., tracking pixels, separators).
        - **Variance:** Detects and skips blank or single-color images.
        - **Compression:** Avoids over-compressed artifacts.
    - **Avatar Filtering:** Intellectually detects and removes avatar images (based on `border-radius: 50%` and size) to prevent them from becoming article thumbnails.
- **üîó Instapaper Integration:** Automatically adds the processed article link to your Instapaper account.
- **üì± Responsive Web Interface:**
    - **Dark Mode:** A clean, dark-themed UI built with Flask.
    - **Statistics:** View storage usage, file counts for articles, images, and data JSONs directly from the dashboard.
    - **Security:** Includes path traversal protection and file whitelisting.
- **üè∑Ô∏è Metadata Extraction:** Extracts and injects Open Graph tags (`og:title`, `og:description`, `og:image`, `og:url`) for better link previews.
- **üßπ Automatic Maintenance:** Automatically cleans up old articles when the count exceeds 50, ensuring disk space is managed efficiently.
- **üê≥ Docker Support:** Ready-to-deploy Docker configuration.

## Installation and Usage

### 1. Environment Variables (.env)

Create a `.env` file in the root directory. This file is critical for the application's configuration.

**Structure:**

```env
# IMAP Settings (For reading emails)
IMAP_SERVER=imap.example.com
EMAIL_USER=your-email@example.com
EMAIL_PASS=your-email-password

# Instapaper Credentials (For saving articles)
INSTAPAPER_USER=your-instapaper-email@example.com
INSTAPAPER_PASS=your-instapaper-password

# Application Settings
API=https://your-public-url.com    # The public URL where this app is hosted (e.g., from VDS or Tunnel)
PORT=5030                          # The port the flask app will run on (Default: 5030)
```

### 2. Running with Docker (Recommended)

Ensure Docker and Docker Compose are installed.

```bash
docker-compose up -d --build
```

This command will build the image and start the container in the background.

### 3. Manual Execution

If you prefer running it directly with Python:

```bash
# Install dependencies
pip install -r requirements.txt

# Run the application
python main.py
```

## File Structure

- `main.py`: Entry point ‚Äî starts the web server and mail listener.
- `src/`: Core application modules:
    - `config.py`: Configuration, environment variables, Flask app instance.
    - `image_utils.py`: Image filtering, hashing, thumbnail processing.
    - `cleanup.py`: Article deletion and old article cleanup.
    - `routes.py`: Flask routes (article serving, image serving, index page).
    - `instapaper.py`: Instapaper API integration.
    - `mail_processor.py`: Email processing and IMAP listener.
- `articles/`: Directory where processed HTML articles are stored.
- `images/`: Directory where downloaded and optimized images are saved.
- `data/`: Stores JSON metadata mappings for each article.
- `sample/`: Sample HTML files for integration testing.
- `tests/`: Test scripts.
- `Dockerfile`: Configuration for building the Docker image.
- `docker-compose.yaml`: Service definition for orchestration.

## License

This project is licensed under the [MIT](LICENSE) license.
